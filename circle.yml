machine:
  environment:
    GOPATH: "/home/ubuntu/.go_workspace"
    CGO_ENABLED: "0"

dependencies:
  pre:
    - go get github.com/mitchellh/gox
    - CGO_ENABLED=0 gox -osarch=linux/amd64 -build-toolchain

    - go get -d github.com/mitchellh/packer
    - sed -i '/VersionPrerelease/ s/""/"dev"/' $GOPATH/src/github.com/mitchellh/packer/version.go


  override:
    - git config --global user.email "you@example.com" &&  git config --global user.name "Your Name"
    - go get -d github.com/MSOpenTech/packer-azure || true
    - cd $GOPATH/src/github.com/MSOpenTech/packer-azure  && curl -L https://github.com/MSOpenTech/packer-azure/pull/36.patch | git am --signoff && go get -tags restapi ./...

  post:
    - tar -czvf $CIRCLE_ARTIFACTS/packer.tgz -C  $GOPATH/bin $(find $GOPATH/bin -name packer\* -printf '%P ')

test:
  override:
    - /bin/true
